{
  "name": "send-appointment-email",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "send-appointment-email",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -220,
        0
      ],
      "id": "ef683a24-2597-4532-b3a6-fb566b566aee",
      "name": "Webhook",
      "webhookId": "3da3ed37-73ed-4386-8438-524842f92fb0"
    },
    {
      "parameters": {
        "sendTo": "={{$json.body.userEmail}}",
        "subject": "=XÃ¡c nháº­n thanh toÃ¡n - {{ $json.body.billId }}",
        "message": "=<!DOCTYPE html>\n<html lang=\"vi\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>XÃ¡c nháº­n Lá»‹ch háº¹n vÃ  Thanh toÃ¡n</title>\n    <style>\n        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 0; background-color: #f5f5f5; }\n        .container { max-width: 600px; margin: 20px auto; background-color: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; overflow: hidden; }\n        .header { background-color: #28a745; color: white; padding: 20px; text-align: center; }\n        .content { padding: 30px; }\n        .info-box { padding: 15px; border-radius: 5px; margin-bottom: 20px; }\n        .payment-info { background-color: #d4edda; border-left: 5px solid #28a745; }\n        .appointment-info { background-color: #e7f3ff; border-left: 5px solid #007bff; }\n        h2 { color: #333333; }\n        p { line-height: 1.6; color: #555555; }\n        strong { color: #333333; }\n        .footer { text-align: center; padding: 20px; font-size: 0.9em; color: #888888; }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <div class=\"header\">\n            <h1>âœ… Thanh toÃ¡n thÃ nh cÃ´ng!</h1>\n            <p>Cáº£m Æ¡n báº¡n Ä‘Ã£ tin tÆ°á»Ÿng dá»‹ch vá»¥ cá»§a chÃºng tÃ´i.</p>\n        </div>\n        <div class=\"content\">\n            <h2>ChÃ o <strong>{{ $json.body.userName }}</strong>,</h2>\n            <p>PhÃ²ng khÃ¡m Ä‘Ã£ nháº­n Ä‘Æ°á»£c thanh toÃ¡n vÃ  xÃ¡c nháº­n lá»‹ch háº¹n cá»§a báº¡n thÃ nh cÃ´ng. Vui lÃ²ng kiá»ƒm tra láº¡i cÃ¡c thÃ´ng tin dÆ°á»›i Ä‘Ã¢y:</p>\n\n            <div class=\"info-box payment-info\">\n                <h3 style=\"margin-top:0; color:#155724;\">ğŸ’° Chi tiáº¿t thanh toÃ¡n</h3>\n                <p><strong>MÃ£ hÃ³a Ä‘Æ¡n:</strong> <code>{{ $json.body.billId }}</code></p>\n                <p><strong>Sá»‘ tiá»n:</strong> <strong style=\"color:#155724;\">{{ $json.body.formattedAmount }}</strong></p>\n                <p><strong>Dá»‹ch vá»¥:</strong> {{ $json.body.serviceName }}</p>\n            </div>\n\n            <div class=\"info-box appointment-info\">\n                <h3 style=\"margin-top:0; color:#004085;\">ğŸ“… ThÃ´ng tin cuá»™c háº¹n</h3>\n                <p><strong>Bá»‡nh nhÃ¢n:</strong> {{ $json.body.userName }}</p>\n                <p><strong>Sá»‘ Ä‘iá»‡n thoáº¡i:</strong> {{ $json.body.userPhone }}</p>\n                <p><strong>BÃ¡c sÄ© phá»¥ trÃ¡ch:</strong> {{ $json.body.doctorName }}</p>\n                <p><strong>NgÃ y khÃ¡m:</strong> <strong>{{ $json.body.appointmentDate }}</strong></p>\n                <p><strong>Giá» khÃ¡m:</strong> <strong>{{ $json.body.appointmentTime }}</strong></p>\n                <p><strong>Äá»‹a Ä‘iá»ƒm:</strong> {{ $json.body.clinicAddress }}</p>\n            </div>\n\n            <p>ğŸ“… <strong>Lá»‹ch háº¹n Ä‘Ã£ Ä‘Æ°á»£c tá»± Ä‘á»™ng thÃªm vÃ o Google Calendar cá»§a báº¡n!</strong></p>\n            <p>Vui lÃ²ng Ä‘áº¿n trÆ°á»›c giá» háº¹n 15 phÃºt Ä‘á»ƒ lÃ m thá»§ tá»¥c. Cáº£m Æ¡n báº¡n ráº¥t nhiá»u!</p>\n        </div>\n        <div class=\"footer\">\n            <p><strong>{{ $json.body.clinicName }}</strong></p>\n            <p>{{ $json.body.clinicAddress }}<br>Hotline: {{ $json.body.clinicPhone }}</p>\n        </div>\n    </div>\n</body>\n</html>",
        "options": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        260,
        0
      ],
      "id": "4c7721fe-d695-41ed-a5b6-1bc9a41abdaf",
      "name": "Send a message",
      "credentials": {
        "gmailOAuth2": {
          "id": "vmipyVUkATcNUeD9",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// TRUY Cáº¬P DATA Tá»ª WEBHOOK NODE TRá»°C TIáº¾P\nconst webhookData = $('Webhook').first().json.body;\n\n// Log chi tiáº¿t Ä‘á»ƒ debug\nconsole.log('ğŸ“¥ RAW WEBHOOK DATA:', JSON.stringify(webhookData, null, 2));\nconsole.log('ğŸ” startDateTime from webhook:', webhookData.startDateTime);\nconsole.log('ğŸ” endDateTime from webhook:', webhookData.endDateTime);\n\n// KIá»‚M TRA vÃ  Sá»¬ Dá»¤NG TRá»°C TIáº¾P startDateTime/endDateTime tá»« Java\nif (!webhookData.startDateTime || !webhookData.endDateTime) {\n  console.error('âŒ MISSING DATETIME:', {\n    startDateTime: webhookData.startDateTime,\n    endDateTime: webhookData.endDateTime\n  });\n  throw new Error('Missing startDateTime or endDateTime from Java backend');\n}\n\n// Sá»¬ Dá»¤NG TRá»°C TIáº¾P datetime tá»« Java (Ä‘Ã£ cÃ³ timezone +07:00)\nlet startDateTime = webhookData.startDateTime;\nlet endDateTime = webhookData.endDateTime;\n\nconsole.log('âœ… USING JAVA DATETIME DIRECTLY:');\nconsole.log('   Start:', startDateTime);\nconsole.log('   End:', endDateTime);\n\n// Táº¡o calendar event vá»›i datetime tá»« Java\nconst calendarEvent = {\n  summary: webhookData.eventTitle || `ğŸ¦· ${webhookData.serviceName} - ${webhookData.userName}`,\n  description: `ğŸ¥ THÃ”NG TIN CUá»˜C Háº¸N CHI TIáº¾T\\n\\nğŸ“‹ Dá»‹ch vá»¥: ${webhookData.serviceName || 'N/A'}\\nğŸ‘¤ Bá»‡nh nhÃ¢n: ${webhookData.userName || 'N/A'}\\nğŸ“ Sá»‘ Ä‘iá»‡n thoáº¡i: ${webhookData.userPhone || 'N/A'}\\nğŸ‘¨â€âš•ï¸ BÃ¡c sÄ© phá»¥ trÃ¡ch: ${webhookData.doctorName || 'N/A'}\\n\\nğŸ“… NgÃ y khÃ¡m: ${webhookData.appointmentDate || 'N/A'}\\nâ° Giá» khÃ¡m: ${webhookData.appointmentTime || 'N/A'}\\nğŸ“ Äá»‹a Ä‘iá»ƒm: ${webhookData.location || 'FPT University ÄÃ  Náºµng'}\\n\\nğŸ’° THÃ”NG TIN THANH TOÃN\\nğŸ’µ Sá»‘ tiá»n: ${webhookData.formattedAmount || webhookData.billAmount || 'N/A'}\\nğŸ§¾ MÃ£ hÃ³a Ä‘Æ¡n: ${webhookData.billId || 'N/A'}\\nğŸ“¦ MÃ£ Ä‘Æ¡n hÃ ng: ${webhookData.orderId || 'N/A'}\\n\\nğŸ¥ THÃ”NG TIN PHÃ’NG KHÃM\\nğŸ¢ TÃªn: ${webhookData.clinicName || 'PhÃ²ng khÃ¡m Nha khoa'}\\nğŸ“ Äá»‹a chá»‰: ${webhookData.clinicAddress || 'FPT University ÄÃ  Náºµng'}\\nğŸ“ Hotline: ${webhookData.clinicPhone || '0936929382'}\\n\\nğŸ“ LÆ¯U Ã QUAN TRá»ŒNG:\\nâ€¢ Vui lÃ²ng Ä‘áº¿n trÆ°á»›c giá» háº¹n 15 phÃºt\\nâ€¢ Mang theo CCCD/CMND vÃ  sá»• khÃ¡m bá»‡nh (náº¿u cÃ³)\\nâ€¢ LiÃªn há»‡ hotline náº¿u cáº§n thay Ä‘á»•i lá»‹ch háº¹n\\n\\nâœ… Lá»‹ch háº¹n nÃ y Ä‘Ã£ Ä‘Æ°á»£c xÃ¡c nháº­n vÃ  thanh toÃ¡n thÃ nh cÃ´ng!`,\n  start: {\n    dateTime: startDateTime,\n    timeZone: 'Asia/Ho_Chi_Minh'\n  },\n  end: {\n    dateTime: endDateTime,\n    timeZone: 'Asia/Ho_Chi_Minh'\n  },\n  location: webhookData.location || webhookData.clinicAddress || 'FPT University ÄÃ  Náºµng',\n  attendees: webhookData.attendees || [\n    { email: webhookData.userEmail },\n    { email: webhookData.doctorEmail }\n  ]\n};\n\nconsole.log('ğŸ“… FINAL CALENDAR EVENT:', JSON.stringify(calendarEvent, null, 2));\nconsole.log('ğŸ¯ DATETIME VERIFICATION:');\nconsole.log('   ğŸ“… Java sent startDateTime:', webhookData.startDateTime);\nconsole.log('   ğŸ“… Calendar will use startDateTime:', calendarEvent.start.dateTime);\nconsole.log('   ğŸ“… Java sent endDateTime:', webhookData.endDateTime);\nconsole.log('   ğŸ“… Calendar will use endDateTime:', calendarEvent.end.dateTime);\n\nreturn [{ json: calendarEvent }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        420,
        0
      ],
      "id": "prepare-calendar-data",
      "name": "Prepare Calendar Data"
    },
    {
      "parameters": {
        "calendar": {
          "__rl": true,
          "value": "de180577tranhongphuoc@gmail.com",
          "mode": "list",
          "cachedResultName": "de180577tranhongphuoc@gmail.com"
        },
        "start": "={{$json.start}}",
        "end": "={{$json.end}}",
        "additionalFields": {
          "attendees": "={{$json.attendees}}",
          "description": "={{$json.description}}",
          "location": "={{$json.location}}",
          "summary": "={{$json.summary}}"
        }
      },
      "type": "n8n-nodes-base.googleCalendar",
      "typeVersion": 1.3,
      "position": [
        580,
        0
      ],
      "id": "46c739b4-f2cb-4ed6-84ab-1a93119aa137",
      "name": "Create an event",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "V5ACSjdT1n29E2kl",
          "name": "Google Calendar account"
        }
      }
    },
    {
      "parameters": {
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        1600,
        0
      ],
      "id": "58593914-41c2-4a33-864b-c2edc8b3af81",
      "name": "Respond to Webhook"
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Send a message",
            "type": "main",
            "index": 0
          },
          {
            "node": "Prepare Calendar Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send a message": {
      "main": [
        []
      ]
    },
    "Prepare Calendar Data": {
      "main": [
        [
          {
            "node": "Create an event",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create an event": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "id": "5IGfp4qZ5uF7WaN0",
  "tags": []
}